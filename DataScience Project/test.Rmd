---
title: "Test"
author: 
date: '2023-03-19'
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r prepare}
library(knitr)
library(kableExtra)
library(Hmisc)
library(dplyr)
library(ggplot2)

getwd()
```

# 0  对结果处理
```{r load}
sample.df <- read.csv(file="./Data/News2.csv", header = T,
                     na.strings=c("","NA","NULL",NULL), sep = ",")


# 查看结果
head(sample.df)

```

# 1. 数据预处理
```{r}
head(sample.df)
```

## 1.1 数据描述

### 查找缺失值
```{r 查找缺失值}
colSums(is.na(sample.df))

sample.df[is.na(sample.df$content.Seg),]

sum(complete.cases(sample.df))
```
```{r 删去没什么内容的条目}
sample.df <- sample.df[-c(21228,29063,30930,35423),]
sample.df[is.na(sample.df$content.Seg),]
```


### 描述
```{r 所有列名}
colnames(sample.df)
```


利用Hmisc包中describe进行描述
GMD(Gini mean difference) - 度量变量的离散值
```{r describe查看分布}
desc <- describe(sample.df)

# 将结果存储到文本文件
sink("describe.txt")
cat(capture.output(desc), sep = "\n")
sink()
```

删掉没用的特征
```{r 去除预处理过程中产生的数据}
sample.df <- dplyr::select(sample.df, -c("url","title","content",
                                        "n_unique_tokens","n_non_stop_words",
                                         "n_non_stop_unique_tokens",
                                         "num_keywords","content.Seg",
                                         "WikiEntity","title.tokens",
                                         "title.tags", "kmeans.Temporary"))


```

查看类型
```{r 转因子变量}
str(sample.df)

# 转因子变量
# num_hrefs 133
# num_self_hrefs 59
# num_imgs 91
# num_videos 53

sample.df$data_channel_is_lifestyle <- 
  as.factor(sample.df$data_channel_is_lifestyle)
sample.df$data_channel_is_entertainment <- 
  as.factor(sample.df$data_channel_is_entertainment)
sample.df$data_channel_is_bus <- 
  as.factor(sample.df$data_channel_is_bus)
sample.df$data_channel_is_socmed <- 
  as.factor(sample.df$data_channel_is_socmed)
sample.df$data_channel_is_tech <- 
  as.factor(sample.df$data_channel_is_tech)
sample.df$data_channel_is_world <- 
  as.factor(sample.df$data_channel_is_world)

sample.df$weekday_is_monday <- 
  as.factor(sample.df$weekday_is_monday)
sample.df$weekday_is_tuesday <- 
  as.factor(sample.df$weekday_is_tuesday)
sample.df$weekday_is_thursday <- 
  as.factor(sample.df$weekday_is_thursday)
sample.df$weekday_is_wednesday <- 
  as.factor(sample.df$weekday_is_wednesday)
sample.df$weekday_is_friday <- 
  as.factor(sample.df$weekday_is_friday)
sample.df$weekday_is_saturday <- 
  as.factor(sample.df$weekday_is_saturday)
sample.df$weekday_is_sunday <- 
  as.factor(sample.df$weekday_is_sunday)
sample.df$is_weekend <- 
  as.factor(sample.df$is_weekend)

# 大部分全都是发在不是节假日日期的
sample.df$isHoliday <- 
  as.factor(sample.df$isHoliday)

sample.df$topicNo <- 
  as.factor(sample.df$topicNo)

# Flesch.Kincaid.Grade.of.Title 122

# All.Possible.Meanings 这个可能需要归一化

sample.df$noun_count <- 
  as.factor(sample.df$noun_count)
sample.df$verb_count <- 
  as.factor(sample.df$verb_count)

# adverb 和 punc偏态都挺严重，可能需要删去
sample.df$adverb_count <- 
  as.factor(sample.df$adverb_count)
sample.df$punc_count <- 
  as.factor(sample.df$punc_count)



# 考虑删除
# Comparatives.Count 
# Superlatives.Count 
# Count.Intensifiers 
# Count.Downtoners 


```

归一化
```{r 将歧义归一化}
normalize <- function(x) {
  return((x - min(x)) / (max(x) - min(x)))
}

# apply normalization to entire data frame
sample.df$All.Possible.Meanings <- normalize(sample.df$All.Possible.Meanings)
```

### 特征分布与异常值
画分布
```{r 直方图}

GetDistribution <- function(df){
  df = as.data.frame(df)
  variable.No <- ncol(df) 

  for(i in 1:variable.No){
    # 判断该列是否为数值型变量
    if (class(df[,i][1])[1] == "numeric") {
      TmpFileName <- paste("PlotHistFigures/",i,"-",colnames(df)[i],".png",sep="")
      png(file=TmpFileName)
      hist(df[,i],xlim=c(min(na.omit(df[,i])),max(na.omit(df[,i])) )) #get hist for each column
      dev.off()
    }
  }
}

GetDistribution(sample.df)
```

查看预测值分布
```{r shares分布}
hist(sample.df$shares)
boxplot(sample.df$shares)
hist(log(sample.df$shares))
```

画箱线图
```{r 箱线图}
# 对于集中于一条线的，例如kw_avg_avg那种，一般是有严重的偏态，一般取对数
# 绘制箱线图，并保存至文件夹内
for (col in names(sample.df)) {
  if (is.numeric(sample.df[[col]][1])){
      filename <- paste0("boxplots/",col, ".png")
      png(filename)
      boxplot(sample.df[[col]], main = col, horizontal = TRUE)
      dev.off()
  }
}
```


## 2. 回归模型拟合

```{r log转换}
sample.df$logShares <- log(sample.df$shares)
```

```{r 划分测试集与训练集}
set.seed(333)
index <- sample(c(1,2), nrow(sample.df), replace = T, prob = c(0.7, 0.3))
train <- sample.df[index==1,]
test <- sample.df[index==2,]
```

```{r 模型拟合}
lm.model <- lm(logShares~timedelta + n_tokens_title + n_tokens_content +
                 num_hrefs + 
    num_self_hrefs + num_imgs + num_videos + average_token_length + 
    data_channel_is_lifestyle + data_channel_is_entertainment + 
    data_channel_is_bus + data_channel_is_socmed + data_channel_is_tech + 
    data_channel_is_world + is_weekend + topicNo + 
          Comparatives.Count + Superlatives.Count + Count.Intensifiers + 
    Flesch.Kincaid.Grade.of.Title + Count.Downtoners + SyntaxTree.Height + 
    All.Possible.Meanings + noun_count + verb_count + adverb_count + 
    punc_count + title_subjectivity + 
      title_sentiment_polarity+
      isHoliday+ContentFleschReadingEase+NWordRatio+
      VWordRatio+wordRatioIn8000+global_subjectivity+global_sentiment_polarity+
      global_rate_positive_words+global_rate_negative_words+novel.of.title+ 
      dayRatio+threeDayRatio+weekRation+twoWeekRation
      -1,
    data = train)
summary(lm.model)
```

```{r MAE}
train_pred <- predict(lm.model, newdata = train)
mean(abs(exp(train_pred) - exp(train$logShares)))
test_pred <- predict(lm.model, newdata = test)
mean(abs(exp(test_pred) - exp(test$logShares)))
```

# 3. 分类模型拟合

## shares分箱

```{r 二分}
range_capture <- function(x) {
    if (x >= 0 & x < 1400) {
        return(0)
    } else {
      return(1)
    }
}

sample.df$result <- as.factor(sapply(sample.df$shares, range_capture))

```

## 划分test train

```{r 划分测试集与训练集}
set.seed(20021119)
index <- sample(c(1,2), nrow(sample.df), replace = T, prob = c(0.7, 0.3))
train <- sample.df[index==1,]
test <- sample.df[index==2,]
```

## 随机森林：选择特征

```{r 随机森林}
library(randomForest)

rf.model <- randomForest::randomForest(result ~ timedelta + n_tokens_title + 
                             n_tokens_content + 
    num_hrefs + num_self_hrefs + num_imgs + num_videos + average_token_length + 
    data_channel_is_lifestyle + data_channel_is_entertainment + 
    data_channel_is_bus + data_channel_is_socmed + data_channel_is_tech + 
    data_channel_is_world + is_weekend + topicNo + Comparatives.Count + 
    Superlatives.Count + Count.Intensifiers + Flesch.Kincaid.Grade.of.Title + 
    Count.Downtoners + SyntaxTree.Height + All.Possible.Meanings + 
    noun_count + verb_count + adverb_count + punc_count + title_subjectivity + 
    title_sentiment_polarity + isHoliday + ContentFleschReadingEase + 
    NWordRatio + VWordRatio + wordRatioIn8000 + global_subjectivity + 
    global_sentiment_polarity + global_rate_positive_words + 
    global_rate_negative_words + novel.of.title+ dayRatio + threeDayRatio +
      weekRation + twoWeekRation, data=train, importance=T, 
    ntree=450, mtry = 10, samplesize=2000)

rf.model
```

### 选择特征
```{r}
train.df <- select(train, c(timedelta,n_tokens_title,n_tokens_content,
    num_hrefs,num_self_hrefs,num_imgs,num_videos,average_token_length , 
    data_channel_is_lifestyle , data_channel_is_entertainment , 
    data_channel_is_bus , data_channel_is_socmed , data_channel_is_tech , 
    data_channel_is_world , is_weekend , topicNo , Comparatives.Count , 
    Superlatives.Count , Count.Intensifiers , Flesch.Kincaid.Grade.of.Title , 
    Count.Downtoners , SyntaxTree.Height , All.Possible.Meanings , 
    noun_count , verb_count , adverb_count , punc_count , title_subjectivity , 
    title_sentiment_polarity , isHoliday , ContentFleschReadingEase , 
    NWordRatio , VWordRatio , wordRatioIn8000 , global_subjectivity , 
    global_sentiment_polarity , global_rate_positive_words , 
    global_rate_negative_words , novel.of.title , dayRatio , threeDayRatio ,
      weekRation , twoWeekRation))
```


```{r}
varImpPlot(rf.model, n.var = 30, main = "Top 30 - Variable Importance")

importance.df <- data.frame(importance(rf.model), check.names = F)
importance.df <- importance.df[order(importance.df$MeanDecreaseGini, 
                                   decreasing = T),]
head(importance.df)
```

```{r}
##交叉验证辅助评估选择特定数量的 Feature
#5 次重复十折交叉验证
set.seed(20021119)
train.cv <- replicate(5, rfcv(train.df, train$result, 
                              cv.fold = 10, step = 1.5), simplify = FALSE)
```

```{r}
#提取验证结果绘图
train.cv <- data.frame(sapply(train.cv, '[[', 'error.cv'))
train.cv$features <- rownames(train.cv)
train.cv <- reshape2::melt(train.cv, id = 'features')
train.cv$features <- as.numeric(as.character(train.cv$features))
 
train.cv.mean <- aggregate(train.cv$value, by = list(train.cv$features), FUN = mean)
head(train.cv.mean, 10)
```


```{r}
#拟合线图
library(ggplot2)
 
ggplot(train.cv.mean, aes(Group.1, x)) +
  geom_line() +
labs(title = '',x = 'Number of Features', y = 'Cross-validation error')
```

```{r}
train.cv.mean
```



```{r}
importance.df <- importance.df[order(importance.df$MeanDecreaseAccuracy, 
                                   decreasing = T),]
features <- rownames(importance.df[1:19,])

formula <- paste0("result ~ ", paste(features, collapse = " + "))

formula
```

```{r}
library(randomForest)

rf.model2 <- randomForest::randomForest(result ~ is_weekend + data_channel_is_world + data_channel_is_entertainment + data_channel_is_socmed + num_imgs + timedelta + n_tokens_content + num_hrefs + global_rate_positive_words + average_token_length + global_subjectivity + global_sentiment_polarity + data_channel_is_tech + data_channel_is_bus + num_self_hrefs + global_rate_negative_words + num_videos + title_sentiment_polarity + title_subjectivity, data=train, importance=T, ntree=200)

rf.model2
```


Confusion Matrix
```{r}
test_pred.rf <- predict(rf.model2, newdata = test)
table(test_pred.rf, test$result)
```

### ROC & AUC

$$ 
TPR = TP / P 
$$

$$
FPR = FP(FalsePositive) / N
$$
目的是取得软分类转硬分类的概率阈值，借以评估分类效果
```{r}
library(pROC)

tableTestBinary <- function(model) {
  p <- predict(model, newdata=test)
  table(p, test$result,dnn=c("预测值","真实值"))
}

tableTrainBinary <- function(model) {
  p <- predict(model, newdata=train)
  table(p, train$result,dnn=c("预测值","真实值"))
}
```

```{r}
plotROC <- function(model, theme) {
  pre_ran <- predict(model, newdata=test)
  ran_roc <- roc(test$result, as.numeric(pre_ran))
  plot(ran_roc, print.auc=TRUE, auc.polygon=TRUE, grid=c(0.1,0.2),grid.col=c("green", "red"), max.auc.polygon=TRUE,auc.polygon.col="skyblue", print.thres=TRUE,main=theme)
}

```

```{r}
plotROC(rf.model, "随机森林")
tableTestBinary(rf.model)
tableTrainBinary(rf.model)

plotROC(rf.model2, "随机森林2")
tableTestBinary(rf.model2)
tableTrainBinary(rf.model2)

```


## C50

```{r}
quantile(sample.df$shares, c(0.01, 0.8))
selectResult2 <- function(x) {
  if (x < 382) {
    return(1)
  } else if (x < 6200) {
    return(2)
  } else {
    return(3)
  }
}
```


```{r}
sample.df$result2 <- as.factor(sapply(sample.df$shares, selectResult2))
set.seed(20021119)
index <- sample(c(1,2), nrow(sample.df), replace = T, prob = c(0.7, 0.3))
train <- sample.df[index==1,]
test <- sample.df[index==2,]

```


```{r}
library(C50)
c50.model <- C5.0(result2 ~ timedelta + n_tokens_title + 
                             n_tokens_content + 
    num_hrefs + num_self_hrefs + num_imgs + num_videos + average_token_length + 
    data_channel_is_lifestyle + data_channel_is_entertainment + 
    data_channel_is_bus + data_channel_is_socmed + data_channel_is_tech + 
    data_channel_is_world + is_weekend + topicNo + Comparatives.Count + 
    Superlatives.Count + Count.Intensifiers + Flesch.Kincaid.Grade.of.Title + 
    Count.Downtoners + SyntaxTree.Height + All.Possible.Meanings + 
    noun_count + verb_count + adverb_count + punc_count + title_subjectivity + 
    title_sentiment_polarity + isHoliday + ContentFleschReadingEase + 
    NWordRatio + VWordRatio + wordRatioIn8000 + global_subjectivity + 
    global_sentiment_polarity + global_rate_positive_words + 
    global_rate_negative_words + novel.of.title+ dayRatio + threeDayRatio +
      weekRation + twoWeekRation, data = train)

plotROC(c50.model, "C50")
tableTestBinary(c50.model)
tableTrainBinary(c50.model)
```


## Naive Bayes
```{r}
library(e1071)
nb.model <- naiveBayes(result2 ~ is_weekend + data_channel_is_world + data_channel_is_entertainment + data_channel_is_socmed + num_imgs + timedelta + n_tokens_content + num_hrefs + global_rate_positive_words + average_token_length + global_subjectivity + global_sentiment_polarity + data_channel_is_tech + data_channel_is_bus + num_self_hrefs + global_rate_negative_words + num_videos + title_sentiment_polarity + title_subjectivity, data=train)
tableTestBinary(nb.model)
tableTrainBinary(nb.model)
```


```{r}
glm.model <- glm(result ~ is_weekend + data_channel_is_world + data_channel_is_entertainment + data_channel_is_socmed + num_imgs + timedelta + n_tokens_content + num_hrefs + global_rate_positive_words + average_token_length + global_subjectivity + global_sentiment_polarity + data_channel_is_tech + data_channel_is_bus + num_self_hrefs + global_rate_negative_words + num_videos + title_sentiment_polarity + title_subjectivity, data=train, family = binomial(link=logit))
```


```{r}
predict_test <- predict(glm.model, newdata = test, type="response") > 0.5


table(predict_test, train$result, dnn=c("p", "t"))
table(predict_test, test$result, dnn = c("p", "t"))
```
